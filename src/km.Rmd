```{r km, cache=cacheon}

kmfunc <- function(time, event, eventname, yposplus = rep(0, 2)) {
  fit <- survfit(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ shf_anemia")),
    data = rsdata
  )

  # c(bottom, left, top, right)
  par(mar = c(6, 4, 1, 4) + 0.1)
  plots <- plot(fit,
    fun = "event",
    ylab = eventname,
    xscale = 30.5,
    yscale = 100,
    col = global_kicols,
    mark.time = FALSE,
    bty = "n",
    xlim = c(0, 6 * 365),
    ylim = c(0, 1),
    xlab = "Years",
    axes = F,
    lwd = 3,
    lty = c(1, 2, 3),
    xaxs = "i", yaxs = "i"
  )


  axis(2, seq(0, 1, 0.25), seq(0, 100, 25), las = 2)
  axis(1, at = seq(0, 6, 1) * 365, seq(0, 6, 1))

  yposm <- 1 - summary(fit, 364.5 * 6)$surv

  ylabs <- bind_cols(
    ypos = c(yposm + yposplus),
    ytext = c("No anemia", "Anemia")
  ) %>%
    arrange(ypos)

  mtext(
    side = 4,
    line = .2,
    at = ylabs$ypos,
    ylabs$ytext,
    las = 1
  )

  mtext("No. at risk", side = 1, line = 3, at = -310, adj = 0, cex = 1)

  mtext("No", side = 1, line = 4, at = -290, adj = 0, cex = 1)
  mtext("Yes", side = 1, line = 5, at = -290, adj = 0, cex = 1)

  nrisk <- summary(fit, seq(0, 6, 1) * 365)$n.risk

  axis(1, at = seq(0, 6, 1) * 365, labels = nrisk[1:7], line = 3, tick = FALSE, cex.axis = 1)
  axis(1, at = seq(0, 6, 1) * 365, labels = nrisk[8:14], line = 4, tick = FALSE, cex.axis = 1)

  # text(20, 0.65, paste0("P-value ", pm), pos = 4)
}
```

```{r kmdeath, fig.cap="1-KM All-cause mortality", cache=cacheon, dependson="km"}
kmfunc(
  time = "sos_outtime_death6y",
  event = "sos_out_death6y",
  eventname = "All-cause mortality (%)",
  yposplus = c(0, 0)
)
```

```{r kmhospany, fig.cap="1-KM All-cause hospitalization", cache=cacheon, dependson="km"}
kmfunc(
  time = "sos_outtime_hospany6y",
  event = "sos_out_hospany6y",
  eventname = "All-cause hospitalization (%)",
  yposplus = c(0, 0)
)
```
